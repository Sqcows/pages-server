# Copyright (C) 2025 SquareCows
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

# Example Traefik Configuration for Forgejo Pages Server Plugin
#
# This file demonstrates how to configure Traefik to use the pages-server plugin.
# Split into static configuration (traefik.yml) and dynamic configuration (dynamic.yml)

---
# ============================================================================
# STATIC CONFIGURATION (traefik.yml)
# ============================================================================
# Place this in your Traefik static configuration file

# Enable the plugin
experimental:
  plugins:
    pages-server:
      moduleName: code.squarecows.com/SquareCows/pages-server
      version: v0.0.1

# Define entry points
entryPoints:
  web:
    address: ":80"
    # HTTP entrypoint - NO automatic redirect configured here
    # The pages-server middleware handles ACME challenges and redirects

  websecure:
    address: ":443"

# Configure Let's Encrypt certificate resolver
certificatesResolvers:
  letsencrypt:
    acme:
      email: admin@example.com
      storage: /letsencrypt/acme.json
      # Use HTTP challenge
      httpChallenge:
        entryPoint: web
      # OR use DNS challenge for wildcard certificates (recommended)
      # dnsChallenge:
      #   provider: cloudflare
      #   resolvers:
      #     - "1.1.1.1:53"
      #     - "8.8.8.8:53"

# Enable API and dashboard (optional)
api:
  dashboard: true
  insecure: false

# Configure providers
providers:
  file:
    filename: /etc/traefik/dynamic.yml
    watch: true

  # Redis provider for dynamic router configuration
  # Enables automatic SSL certificate provisioning for custom domains
  redis:
    endpoints:
      - "valkey:6379"
    rootKey: "traefik"
    # password: ""  # Uncomment if authentication required

# Logging
log:
  level: INFO

accessLog:
  filePath: /var/log/traefik/access.log

---
# ============================================================================
# DYNAMIC CONFIGURATION (dynamic.yml)
# ============================================================================
# Place this in your Traefik dynamic configuration file

http:
  # Define the pages-server middleware
  middlewares:
    pages-server:
      plugin:
        pages-server:
          # Required settings
          pagesDomain: pages.example.com
          forgejoHost: https://git.example.com

          # Optional: Forgejo API token (required for private repositories)
          forgejoToken: your-forgejo-api-token-here

          # Optional: Custom error pages repository
          errorPagesRepo: system/error-pages

          # Optional: Custom domain settings
          enableCustomDomains: true  # Default: true
          customDomainCacheTTL: 600  # Cache TTL for custom domain registrations (seconds)
                                      # Custom domains must be activated by visiting the
                                      # pages URL: https://username.pages.example.com/repository

          # Optional: Redis caching (leave empty to use in-memory cache)
          # redisHost: localhost
          # redisPort: 6379
          # redisPassword: ""
          # cacheTTL: 300

          # Optional: Traefik Redis router integration (for automatic SSL certificates)
          traefikRedisRouterEnabled: true  # Default: true
          traefikRedisCertResolver: letsencrypt  # Which cert resolver to use
          traefikRedisRouterTTL: 600  # Router config TTL in seconds (default: same as customDomainCacheTTL)
          traefikRedisRootKey: traefik  # Redis root key for Traefik config

  # Define the routers for pages
  # IMPORTANT: Split HTTP and HTTPS routers for correct ACME challenge handling
  routers:
    # ========================================================================
    # HTTPS ROUTERS (websecure entrypoint)
    # ========================================================================

    # Router for pages domain (e.g., *.pages.example.com) - HTTPS
    pages-https:
      rule: "HostRegexp(`{subdomain:[a-z0-9-]+}.pages.example.com`)"
      priority: 10  # Higher priority than custom domain router
      entryPoints:
        - websecure
      service: noop@internal
      middlewares:
        - pages-server
      tls:
        certResolver: letsencrypt
        domains:
          - main: "pages.example.com"
            sans:
              - "*.pages.example.com"

    # Router for custom domains - HTTPS
    # This catches all domains not matched by pages-https router
    # NOTE: When traefikRedisRouterEnabled is true, individual routers for
    # custom domains are dynamically created in Redis with their own TLS config.
    # This catch-all router provides fallback behavior.
    pages-custom-domains-https:
      rule: "HostRegexp(`{domain:.+}`)"
      priority: 1  # Lower priority - catches all other domains
      entryPoints:
        - websecure
      service: noop@internal
      middlewares:
        - pages-server
      # TLS certificates managed by dynamically-created routers in Redis
      # Individual routers are created per custom domain with certResolver
      # If you disable traefikRedisRouterEnabled, uncomment the tls section:
      # tls:
      #   certResolver: letsencrypt

    # ========================================================================
    # HTTP ROUTER (web entrypoint)
    # ========================================================================
    # Single HTTP router for all domains
    # The pages-server middleware handles:
    #   1. ACME challenge passthrough (/.well-known/acme-challenge/*)
    #   2. HTTP to HTTPS redirect for all other requests
    pages-http:
      rule: "HostRegexp(`{domain:.+}`)"
      entryPoints:
        - web
      service: noop@internal
      middlewares:
        - pages-server

---
# ============================================================================
# DOCKER COMPOSE EXAMPLE
# ============================================================================
# Example docker-compose.yml for running Traefik with the plugin

# version: '3.8'
#
# services:
#   traefik:
#     image: traefik:v2.10
#     container_name: traefik
#     restart: unless-stopped
#     security_opt:
#       - no-new-privileges:true
#     ports:
#       - "80:80"
#       - "443:443"
#     volumes:
#       - /var/run/docker.sock:/var/run/docker.sock:ro
#       - ./traefik.yml:/etc/traefik/traefik.yml:ro
#       - ./dynamic.yml:/etc/traefik/dynamic.yml:ro
#       - ./letsencrypt:/letsencrypt
#       - ./logs:/var/log/traefik
#     networks:
#       - traefik
#     depends_on:
#       - valkey
#
#   # Redis-compatible cache (Valkey)
#   # Required for Redis provider and optional for plugin caching
#   valkey:
#     image: valkey/valkey:latest
#     container_name: valkey
#     restart: unless-stopped
#     command: valkey-server --save 60 1 --loglevel warning
#     volumes:
#       - valkey-data:/data
#     networks:
#       - traefik
#
# volumes:
#   valkey-data:
#
# networks:
#   traefik:
#     external: true

---
# ============================================================================
# DNS SETUP FOR CUSTOM DOMAINS
# ============================================================================
# To use custom domains, you must manually configure DNS records with your
# DNS provider:
#
# 1. For wildcard pages domain support:
#    - Type: A
#    - Name: *.pages.example.com
#    - Value: [Your Traefik server IP]
#
# 2. For specific custom domains (configured in .pages files):
#    - Type: A
#    - Name: www.example.com
#    - Value: [Your Traefik server IP]
#    OR
#    - Type: CNAME
#    - Name: www.example.com
#    - Value: username.pages.example.com
#
# 3. Activate your custom domain:
#    - Visit https://username.pages.example.com/repository
#    - This registers the custom domain from your .pages file
#    - Custom domain is now active for 600 seconds (configurable)
#    - Visit pages URL again to refresh the registration
#
# 4. Traefik will automatically handle SSL certificate generation via
#    Let's Encrypt for all configured domains
#
# IMPORTANT: ACME Challenge Handling
# - The pages-server middleware automatically detects and passes through
#   ACME HTTP challenges (/.well-known/acme-challenge/*)
# - This allows Let's Encrypt to validate custom domains and generate
#   SSL certificates
# - You do NOT need to configure special rules for ACME challenges
# - The middleware handles this automatically before the HTTPS redirect

---
# ============================================================================
# TRAEFIK REDIS PROVIDER FOR AUTOMATIC SSL CERTIFICATES
# ============================================================================
# The plugin automatically registers custom domains with Traefik's Redis
# provider, enabling automatic SSL certificate provisioning.
#
# How it works:
# 1. User visits https://username.pages.example.com/repository
# 2. Plugin detects custom domain in repository's .pages file
# 3. Plugin writes Traefik router configuration to Redis:
#    - traefik/http/routers/custom-domain-com/rule = "Host(`domain.com`)"
#    - traefik/http/routers/custom-domain-com/tls/certResolver = "letsencrypt"
#    - ... (additional router configuration)
# 4. Traefik's Redis provider automatically loads the new router
# 5. Traefik requests SSL certificate from Let's Encrypt
# 6. Custom domain now has automatic HTTPS!
#
# Configuration:
# - Enable Redis caching in plugin configuration (redisHost, redisPort)
# - Add Redis provider to Traefik static configuration (see above)
# - Configure traefikRedisCertResolver to match your cert resolver name
# - Ensure traefikRedisRootKey matches the rootKey in Redis provider config
#
# Redis Keys Created (per custom domain):
# - traefik/http/routers/custom-{sanitized-domain}/rule
# - traefik/http/routers/custom-{sanitized-domain}/entryPoints/0
# - traefik/http/routers/custom-{sanitized-domain}/middlewares/0
# - traefik/http/routers/custom-{sanitized-domain}/service
# - traefik/http/routers/custom-{sanitized-domain}/tls/certResolver
# - traefik/http/routers/custom-{sanitized-domain}/priority
#
# TTL:
# Router configurations expire after traefikRedisRouterTTL seconds (default: 600).
# Visit the pages URL again to refresh the registration.
#
# Disabling:
# Set traefikRedisRouterEnabled: false to disable automatic router registration.
# When disabled, the catch-all router (pages-custom-domains-https) should have
# its tls.certResolver uncommented to handle SSL for custom domains.

---
# ============================================================================
# ENVIRONMENT VARIABLES FOR SECRETS
# ============================================================================
# For production, use environment variables for sensitive data:
#
# In your docker-compose.yml or system environment:
#   FORGEJO_API_TOKEN=your-token
#
# Then reference them in dynamic.yml:
#   forgejoToken: ${FORGEJO_API_TOKEN}
